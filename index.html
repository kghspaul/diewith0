<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Die With Zero è²¡å‹™è¨ˆç®—æ©Ÿ Pro (v3.7 è‡ªè¨‚çµ„åˆç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* äº«æ¨‚æ©˜ */
            --growth: #27ae60; /* ç´¯ç©ç¶  */
            --house: #8e44ad;   /* è²·æˆ¿ç´« */
            --flat: #7f8c8d;    /* å¹³æ»‘ç° */
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text-light: #636e72;
            --hint-color: #95a5a6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            padding-bottom: 60px; /* For footer */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        h1 { text-align: center; margin-bottom: 5px; color: var(--primary); letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: var(--text-light); font-size: 0.95em; margin-bottom: 30px; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 30px; background: #dfe6e9; border-radius: 12px; padding: 5px; }
        .tab-btn {
            flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: bold;
            border-radius: 10px; color: var(--text-light); transition: 0.2s; font-size: 1.05em;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.5); }
        .tab-btn.active.mode-retire { background: #fff; color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .tab-btn.active.mode-young { background: #fff; color: var(--growth); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Form Layout */
        .section-title {
            font-size: 1.2em; font-weight: 700; margin: 30px 0 20px 0; padding-left: 12px;
            border-left: 5px solid #ddd; color: var(--primary); display: flex; align-items: center; justify-content: space-between;
        }
        .mode-retire .section-title { border-color: var(--accent); }
        .mode-young .section-title { border-color: var(--growth); }
        .section-title.house-title { border-color: var(--house); color: var(--house); cursor: pointer; user-select: none; }
        .section-title.house-title:hover { background-color: #fcf6ff; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .input-group { margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.95em; color: #2d3436; }
        input[type="number"], select {
            width: 100%; padding: 14px; border: 2px solid #e1e4e8; border-radius: 10px;
            font-size: 1.05em; transition: 0.2s; box-sizing: border-box; background: #fff; color: #2d3436;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(44,62,80,0.05); }

        .hint {
            font-size: 0.85em; color: var(--hint-color); margin-top: 6px; line-height: 1.4;
            padding-left: 2px;
        }
        .hint strong { color: #636e72; font-weight: 600; }

        /* Tags / Presets */
        .presets-label { font-size: 0.8em; color: var(--hint-color); margin-bottom: 6px; margin-top: 5px; display: block;}
        .presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
        .tag {
            background: #f1f3f5; padding: 6px 12px; border-radius: 8px; font-size: 0.85em;
            color: #636e72; cursor: pointer; border: 1px solid #dfe6e9; transition: 0.2s; user-select: none;
        }
        .tag:hover { background: #e2e6ea; border-color: #ced4da; transform: translateY(-1px); }
        .tag.selected { background: #dbe4ff; color: #3b5bdb; border-color: #bac8ff; font-weight: bold; }
        .tag.action-btn { background: #fff8e1; color: #b7791f; border-color: #ffeeba; }
        .tag.risk-high { color: #c0392b; background: #fcebe6; border-color: #fadbd8; }
        .tag.custom-btn { background: #e3fafc; color: #0c8599; border-color: #99e9f2; }

        /* Custom Portfolio Builder */
        .custom-portfolio-box {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-top: 10px; display: none;
        }
        .cp-row { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 8px; }
        .cp-row select { padding: 8px; font-size: 0.9em; height: auto; }
        .cp-row input { padding: 8px; font-size: 0.9em; height: auto; }
        .cp-footer { text-align: right; font-size: 0.85em; color: #7f8c8d; margin-top: 5px; }

        /* House Section */
        #house-section {
            background: #fdfbff; border: 2px dashed #d7bde2; padding: 20px; border-radius: 12px; display: none; margin-bottom: 20px;
        }
        #house-toggle-text::after { content: ' â–¼'; font-size: 0.8em; }
        #house-section.show { display: block; animation: fadeIn 0.3s; }

        /* Buttons */
        .btn-calc {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-size: 1.2em; font-weight: 800; color: white; cursor: pointer;
            margin-top: 30px; transition: 0.2s; letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-retire { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-young { background: linear-gradient(135deg, #27ae60, #219150); }

        /* Result Area */
        .result-box {
            margin-top: 50px; padding: 30px; border-radius: 16px; background: #fff;
            border: 2px solid #f1f3f5; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }
        
        .result-header { text-align: center; margin-bottom: 30px; }
        .purchasing-power-badge {
            display: inline-block; background: #e3f2fd; color: #1565c0; padding: 6px 15px;
            border-radius: 30px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px;
            border: 1px solid #bbdefb;
        }

        .phase-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .phase-card {
            flex: 1; padding: 25px 20px; border-radius: 15px; text-align: center; color: white;
            position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .phase-card:hover { transform: translateY(-5px); }
        .phase-card::before {
            content: ''; position: absolute; top:0; left:0; right:0; height: 6px; background: rgba(0,0,0,0.15);
        }
        .p-gold { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .p-silver { background: linear-gradient(135deg, #bdc3c7, #7f8c8d); }
        .p-bronze { background: linear-gradient(135deg, #90e0ef, #0077b6); }

        .p-title { font-size: 0.95em; opacity: 0.95; margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px; }
        .p-amt { font-size: 1.8em; font-weight: 800; margin: 5px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .p-desc { font-size: 0.85em; opacity: 0.9; margin-top: 5px; }

        /* Comparison Box */
        .comparison-box {
            background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            border: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between;
        }
        .comp-label { font-size: 0.9em; color: #7f8c8d; font-weight: bold; }
        .comp-val { font-size: 1.4em; font-weight: 800; color: var(--flat); }
        .comp-note { font-size: 0.8em; color: #95a5a6; }
        .vs-badge { background: #eee; padding: 5px 10px; border-radius: 50%; font-weight: bold; color: #7f8c8d; font-size: 0.8em;}

        /* Section Separator Title */
        .dwz-section-title {
            text-align: center; font-weight: 800; color: var(--accent); margin: 35px 0 15px 0;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1em;
        }
        .dwz-section-title::before, .dwz-section-title::after {
            content: ''; height: 1px; width: 30px; background: #ffe0b2;
        }

        .chart-header {
            font-size: 0.9em; font-weight: bold; color: #2c3e50; margin: 20px 0 10px 0; 
            padding-left: 10px; border-left: 4px solid #ddd;
        }

        .chart-wrap { position: relative; height: 350px; width: 100%; margin-bottom: 30px;}

        /* Footer Note */
        .footer-note {
            margin-top: 50px; border-top: 1px solid #ddd; padding-top: 20px;
            font-size: 0.85em; color: #7f8c8d; background: #f4f6f8;
        }
        .footer-note h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .footer-note ol { padding-left: 20px; margin: 0; }
        .footer-note li { margin-bottom: 10px; }

        @media (max-width: 700px) {
            .grid-2, .phase-container, .comparison-box { grid-template-columns: 1fr; flex-direction: column; gap: 15px; }
            .container { padding: 20px; }
            .p-amt { font-size: 1.5em; }
            .comparison-box { text-align: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Die With Zero è²¡å‹™è¨ˆç®—æ©Ÿ <span style="font-size:0.5em; vertical-align:top; background:#f1f3f5; padding:3px 6px; border-radius:4px; color:#666; border:1px solid #ddd;">PRO v3.7</span></h1>
    <p class="subtitle">å°‡æ‚¨çš„è³‡ç”¢è½‰æ›ç‚ºäººç”Ÿé«”é©—ç©åˆ†ãƒ»å…¨è‡ªå‹•é€šè†¨è³¼è²·åŠ›æ ¡æ­£</p>

    <div style="text-align:center; margin-bottom:10px; font-size:0.85em; color:#95a5a6;">ğŸ‘‡ è«‹å…ˆé¸æ“‡æ‚¨çš„èº«åˆ†æ¨¡å¼</div>
    <div class="tabs">
        <div class="tab-btn active mode-retire" onclick="switchMode('retire')">ğŸ‘´ æˆ‘å·²é€€ä¼‘<div style="font-size:0.75em; font-weight:normal; margin-top:3px;">(æé ˜æ¨¡å¼)</div></div>
        <div class="tab-btn mode-young" onclick="switchMode('young')">ğŸ§‘ é‚„åœ¨åŠªåŠ›<div style="font-size:0.75em; font-weight:normal; margin-top:3px;">(è³‡ç”¢ç´¯ç©+è²·æˆ¿æ¨¡æ“¬)</div></div>
    </div>

    <div class="input-group">
        <label>ğŸ’¸ æœªä¾†å¹³å‡é€šè†¨ç‡ (Inflation Rate)</label>
        <div class="grid-2" style="grid-template-columns: 1fr 2fr; gap:15px;">
            <input type="number" id="inflation" value="2.5" step="0.1">
            <div>
                <span class="presets-label">ğŸ‘‡ é»æ“Šå¿«é€Ÿå¸¶å…¥åƒè€ƒå€¼ï¼š</span>
                <div class="presets">
                    <div class="tag" onclick="setVal('inflation', 1.5)">1.5% (å®˜æ–¹æ•¸æ“š)</div>
                    <div class="tag selected" onclick="setVal('inflation', 2.5)">2.5% (æŠ˜è¡·å»ºè­°)</div>
                    <div class="tag" onclick="setVal('inflation', 3.0)">3.0% (é«”æ„Ÿé€šè†¨)</div>
                </div>
            </div>
        </div>
        <div class="hint">
            <strong>å½±éŸ¿è³¼è²·åŠ›ï¼š</strong>æ­¤æ•¸å€¼æ±ºå®šæœªä¾†ã€ŒéŒ¢è®Šè–„ã€çš„é€Ÿåº¦ã€‚è‹¥è¨­ç‚º 2.5%ï¼Œä»£è¡¨ 30 å¹´å¾Œçš„ 100 å…ƒåªå‰©ç¾åœ¨ç´„ 47 å…ƒçš„åƒ¹å€¼ã€‚ç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨æ›ç®—ã€‚
        </div>
    </div>

    <div id="tab-retire" class="tab-content active mode-retire">
        <div class="section-title">Step 1: ç›¤é»æ‚¨çš„ç¾æ³</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ’° ç¾æœ‰å¯æŠ•è³‡è³‡ç”¢ (è¬)</label>
                <input type="number" id="r-assets" value="1000" placeholder="ä¾‹: 1000">
                <div class="hint">è«‹è¼¸å…¥è‚¡ç¥¨ã€åŸºé‡‘ã€å®šå­˜ã€ç¾é‡‘ç¸½å’Œã€‚<br>âš ï¸ <strong>ä¸åŒ…å«</strong>è‡ªä½ä¸”ä¸æ‰“ç®—è³£å‡ºçš„æˆ¿ç”¢ã€‚</div>
            </div>
            <div class="input-group">
                <label>ğŸ›¡ï¸ ç·Šæ€¥é å‚™é‡‘(è¬)</label>
                <input type="number" id="r-buffer" value="300" placeholder="ä¾‹: 300">
                <div class="hint">é€™ç­†éŒ¢æ˜¯æ‚¨çš„<strong>å®‰å…¨æ°£å›Š</strong>ï¼Œåœ¨è¨ˆç®—æ™‚æœƒå…ˆè¢«æ‰£é™¤ï¼Œå»ºè­°ä¿ç•™1-2å¹´ç”Ÿæ´»è²»</div>
            </div>
        </div>

        <div class="section-title">Step 2: è¨­å®šæ™‚é–“èˆ‡å ±é…¬</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ‘¤ ç›®å‰å¹´é½¡ (æ­²)</label>
                <input type="number" id="r-age-now" value="55">
                <div class="hint">æ‚¨çš„ç¾åœ¨å¹´é½¡ï¼Œè¨ˆç®—å°‡å¾ä»Šå¹´é–‹å§‹ã€‚</div>
            </div>
            <div class="input-group">
                <label>ğŸ äººç”Ÿç™»å‡ºå¹´é½¡ (æ­²)</label>
                <input type="number" id="r-age-end" value="85">
                <div class="hint">è¨­å®šä¸€å€‹æ‚¨é æœŸçš„äººç”Ÿçµ‚é»ã€‚Die With Zero çš„ç›®æ¨™æ˜¯åœ¨é€™ä¸€å¹´è³‡ç”¢å‰›å¥½æ­¸é›¶ (é™¤é å‚™é‡‘å¤–)ã€‚</div>
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ“ˆ æŠ•è³‡çµ„åˆé æœŸå ±é…¬ç‡ (åç›®, %)</label>
            <input type="number" id="r-rate" value="4.5" step="0.1">
            <span class="presets-label">ğŸ‘‡ é»æ“Šå¿«é€Ÿå¸¶å…¥åƒè€ƒé…ç½®ï¼š</span>
            <div class="presets">
                <div class="tag" onclick="toggleCustom('retire', false); setVal('r-rate', 5.5)">ç©©å¥é ˜æ¯ (0056)</div>
                <div class="tag selected" onclick="toggleCustom('retire', false); setVal('r-rate', 4.5)">å¹³è¡¡å‹ (0050 / ç¾é‡‘å„åŠ)</div>
                <div class="tag" onclick="toggleCustom('retire', false); setVal('r-rate', 6.5)">ç¾è‚¡å¹³è¡¡å‹ (VOO / çŸ­å‚µå„åŠ)</div>
                <div class="tag risk-high" onclick="toggleCustom('retire', false); setVal('r-rate', 15)">ç©æ¥µå‹(æ­å°00631L)</div>
                <div class="tag custom-btn" onclick="toggleCustom('retire', true)">âš™ï¸ è‡ªè¨‚æŠ•è³‡çµ„åˆ</div>
            </div>

            <div id="cp-box-retire" class="custom-portfolio-box">
                <div style="font-weight:bold; margin-bottom:8px; font-size:0.9em;">ğŸ—ï¸ å»ºæ§‹æ‚¨çš„é€€ä¼‘æŠ•è³‡çµ„åˆï¼š</div>
                </div>

            <div class="hint">
                é€™ç­†è³‡é‡‘åœ¨é€€ä¼‘æœŸé–“æŒçºŒæ»¾å‹•çš„é æœŸå¹´åŒ–å ±é…¬ã€‚å»ºè­°è¨­å®šæ¯”æ­·å²å¹³å‡ç¨ä½ï¼Œä»¥ä½œç‚ºå®‰å…¨é‚Šéš›ã€‚<br>
                <span style="color:#c0392b;">*æ³¨æ„ï¼š00631L (å…ƒå¤§å°ç£äº”åæ­£2) æ³¢å‹•æ¥µå¤§ï¼Œé€€ä¼‘æé ˜æœŸè‹¥é‡å¤§è·Œæ˜“é€ æˆè³‡ç”¢å¤§å¹…ç¸®æ°´ï¼Œæ•…å»ºè­°æ‰‹é‚Šä¿æŒä¸€åˆ°å…©å¹´ç”Ÿæ´»è²»ï¼Œè‹¥é€€ä¼‘é åˆ°å¤§è·Œå‰‡æš«åœæé ˜ï¼Œç”šè‡³åŠ ç¢¼ã€‚</span>
            </div>
        </div>

        <button class="btn-calc btn-retire" onclick="calcRetire()">ğŸš€ è¨ˆç®—æˆ‘çš„ã€Œäº«æ¨‚é ç®—ã€</button>
        <div class="hint" style="text-align:center;">é»æ“Šå¾Œå°‡é¡¯ç¤ºå‹•æ…‹æé ˜å»ºè­°åœ–è¡¨</div>
    </div>

    <div id="tab-young" class="tab-content mode-young">
        <div class="section-title">Step 1: ç´¯ç©æœŸ (ç¾åœ¨ â†’ é€€ä¼‘)</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ‘¤ ç›®å‰å¹´é½¡</label>
                <input type="number" id="y-age-now" value="30">
            </div>
            <div class="input-group">
                <label>ğŸ–ï¸ é è¨ˆé€€ä¼‘å¹´é½¡</label>
                <input type="number" id="y-age-retire" value="55">
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ¦ ç›®å‰å·²æœ‰è³‡ç”¢ (è¬)</label>
                <input type="number" id="y-current" value="100">
                <div class="hint">æ‚¨ç›®å‰æ‰‹é‚Šå·²æŠ•å…¥æŠ•è³‡çš„æœ¬é‡‘ç¸½é¡ã€‚</div>
            </div>
            <div class="input-group">
                <label>ğŸ’µ æ¯æœˆå®šæœŸå®šé¡æŠ•å…¥ (å…ƒ)</label>
                <input type="number" id="y-monthly" value="20000">
                <div class="hint">æ‚¨æ‰¿è«¾æ¯å€‹æœˆæŒçºŒæŠ•å…¥å¸‚å ´çš„æ–°å¢è³‡é‡‘ã€‚</div>
            </div>
        </div>
        
        <div class="input-group">
            <label>ğŸš€ ç´¯ç©æœŸé æœŸå ±é…¬ç‡ (%)</label>
            <div class="grid-2" style="grid-template-columns: 1fr 3fr; gap:15px;">
                <input type="number" id="y-rate-acc" value="8.0" step="0.1">
                <div>
                    <span class="presets-label">ğŸ‘‡ æ­·å²å¹´åŒ–å ±é…¬åƒè€ƒï¼š</span>
                    <div class="presets">
                        <div class="tag" onclick="toggleCustom('young', false); setVal('y-rate-acc', 8)">0050 (~8%)</div>
                        <div class="tag" onclick="toggleCustom('young', false); setVal('y-rate-acc', 9)">VOO (~9%)</div>
                        <div class="tag" onclick="toggleCustom('young', false); setVal('y-rate-acc', 11)">QQQ (~11%)</div>
                        <div class="tag risk-high" onclick="toggleCustom('young', false); setVal('y-rate-acc', 15)">00631L (~15%)</div>
                        <div class="tag custom-btn" onclick="toggleCustom('young', true)">âš™ï¸ è‡ªè¨‚æŠ•è³‡çµ„åˆ</div>
                    </div>
                </div>
            </div>

            <div id="cp-box-young" class="custom-portfolio-box">
                <div style="font-weight:bold; margin-bottom:8px; font-size:0.9em;">ğŸ—ï¸ å»ºæ§‹æ‚¨çš„ç´¯ç©æœŸçµ„åˆï¼š</div>
                </div>

            <div class="hint">
                é€™æ˜¯æ‚¨åœ¨å·¥ä½œæœŸé–“ï¼Œè³‡ç”¢æ»¾å‹•çš„é€Ÿåº¦ã€‚<br>
                <span style="color:#c0392b;">*æ³¨æ„ï¼šé›–ç„¶00631Låœ¨å¤šé ­å¹´å¯èƒ½ç¿»å€ï¼Œä½†è€ƒæ…®åˆ°é•·æœŸè€—æèˆ‡ç©ºé ­é¢¨éšªï¼Œè¨ˆç®—æ©Ÿåƒè€ƒå€¼è¨­å®šç‚º 15% (æ¯” 0050 çš„ 8% ç´„å…©å€ç•¥ä½ï¼Œä½œç‚ºä¿å®ˆä¸€é»çš„é•·æœŸé ä¼°)ã€‚</span>
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ‘´ é ä¼°é€€ä¼‘é‡‘ä¸€æ¬¡é ˜ç¸½é¡ (è¬)</label>
            <input type="number" id="y-pension" value="200" placeholder="é¸å¡«ï¼Œä¾‹å¦‚ 200">
            <div class="hint">å¦‚å‹é€€æ–°åˆ¶ã€å…¬ä¿ç­‰ã€‚é€™ç­†éŒ¢æœƒåœ¨æ‚¨é€€ä¼‘é‚£ä¸€å¹´ä¸€æ¬¡æ€§æ³¨å…¥æ‚¨çš„è³‡ç”¢æ± ã€‚<br>(ä¸ç¢ºå®šå¯ç•™ç™½æˆ–å¡« 0)</div>
        </div>

        <div class="section-title house-title" onclick="toggleHouse()">
            <span id="house-toggle-text">ğŸ  è²·æˆ¿è¨ˆç•« (é»æ“Šå±•é–‹è©¦ç®—)</span>
            <input type="checkbox" id="house-enabled" style="display:none">
        </div>
        <div id="house-section">
            <div class="hint" style="margin-bottom:15px;">
                <strong>åŠŸèƒ½èªªæ˜ï¼š</strong>æ­¤åŠŸèƒ½æ¨¡æ“¬åœ¨æŸå€‹å¹´é½¡é»ï¼Œè³‡ç”¢æ± çªç„¶æ‰£é™¤ä¸€ç­†ã€Œé ­æœŸæ¬¾ã€ï¼Œä¸”ä¹‹å¾Œæ¯æœˆæŠ•è³‡é‡‘é¡å› ç¹³æˆ¿è²¸è€Œæ¸›å°‘(æˆ–å¢åŠ )çš„ç‹€æ³ã€‚
            </div>
            <div class="grid-2">
                <div class="input-group">
                    <label>ğŸ“… é è¨ˆè²·æˆ¿å¹´é½¡ (æ­²)</label>
                    <input type="number" id="h-age" value="35">
                    <div class="hint">åœ¨é€™ä¸€å¹´çš„å¹´åˆé€²è¡Œè²·æˆ¿ã€‚</div>
                </div>
                <div class="input-group">
                    <label>ğŸ·ï¸ æˆ¿å±‹ç¸½åƒ¹ (è¬)</label>
                    <input type="number" id="h-price" value="1500">
                </div>
            </div>
            <div class="grid-2">
                <div class="input-group">
                    <label>ğŸ’° é ­æœŸæ¬¾æ¯”ä¾‹ (%)</label>
                    <input type="number" id="h-down-pct" value="20">
                    <div class="hint">ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é ­æœŸæ¬¾é‡‘é¡ï¼Œä¸¦å¾ç•¶å¹´åº¦ç´¯ç©è³‡ç”¢ä¸­<strong>ä¸€æ¬¡æ‰£é™¤</strong>ã€‚</div>
                </div>
                <div class="input-group">
                    <label>ğŸ’¸ æˆ¿è²¸åˆ©ç‡ (%) / å¹´é™ (å¹´)</label>
                    <div style="display:flex; gap:10px">
                        <input type="number" id="h-rate" value="2.2" step="0.1" placeholder="åˆ©ç‡">
                        <input type="number" id="h-years" value="30" placeholder="å¹´é™">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ  åŸæœ¬çš„æˆ¿ç§Ÿé ç®— (å…ƒ/æœˆ)</label>
                <input type="number" id="h-rent" value="15000">
                <div class="hint">
                    <strong>é‡è¦é‚è¼¯ï¼š</strong>è²·æˆ¿å¾Œï¼Œæ‚¨åŸæœ¬ç”¨ä¾†ä»˜æˆ¿ç§Ÿçš„éŒ¢æœƒè½‰å»ç¹³æˆ¿è²¸ã€‚<br>
                    è‹¥ <strong>æˆ¿è²¸ > æˆ¿ç§Ÿ</strong>ï¼Œå·®é¡æœƒ<strong>æ’æ“ </strong>æ‚¨åŸæœ¬è¨­å®šçš„æ¯æœˆæŠ•è³‡é‡‘é¡ (å®šæœŸå®šé¡æœƒè®Šå°‘)ã€‚
                </div>
            </div>
        </div>

        <div class="section-title">Step 2: æé ˜æœŸ (é€€ä¼‘ â†’ ç™»å‡º)</div>
        <div class="grid-2">
             <div class="input-group">
                <label>ğŸ äººç”Ÿç™»å‡ºå¹´é½¡</label>
                <input type="number" id="y-age-end" value="85">
                <div class="hint">Die With Zero çš„è¦åŠƒçµ‚é»ï¼Œåœ¨æ­¤ä¹‹å¾Œè³‡ç”¢æ­¸é›¶ã€‚</div>
            </div>
            <div class="input-group">
                <label>ğŸ›¡ï¸ é€€ä¼‘å¾Œä¿ç•™é å‚™é‡‘ (%)</label>
                <input type="number" id="y-buffer-pct" value="20">
                <div class="hint">é€€ä¼‘é‚£ä¸€å¤©ï¼Œå»ºè­°ä¿ç•™å¤šå°‘æ¯”ä¾‹çš„éŒ¢ä¸å‹•ç”¨(åšç‚ºå®‰å…¨æ°£å›Š)<br><strong>å»ºè­°å€¼ï¼š20%~30%ã€‚</strong></div>
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ¢ é€€ä¼‘å¾ŒæŠ•è³‡å ±é…¬ç‡ (%)</label>
            <div class="grid-2" style="grid-template-columns: 1fr 3fr; gap:15px;">
                <input type="number" id="y-rate-dec" value="4.5" step="0.1">
                <div>
                    <span class="presets-label">ğŸ‘‡ è¨­å®šæ‚¨çš„é€€ä¼‘æŠ•è³‡é¢¨æ ¼ï¼š</span>
                    <div class="presets">
                        <div class="tag action-btn" onclick="copyRateToDec()">ğŸ”„ ç¶­æŒä¸è®Š (åŒç´¯ç©æœŸ)</div>
                        <div class="tag" onclick="setVal('y-rate-dec', 5.5)">ç©©å¥ (0056)</div>
                        <div class="tag" onclick="setVal('y-rate-dec', 4.5)">å¹³è¡¡ (0050+ç¾)</div>
                        <div class="tag" onclick="setVal('y-rate-dec', 6.5)">é…ç½® (VOO+çŸ­å‚µ)</div>
                    </div>
                </div>
            </div>
            <div class="hint">
                å¤šæ•¸äººé€€ä¼‘å¾Œæœƒè½‰è¶¨ä¿å®ˆï¼Œä½†è‹¥æ‚¨é€€ä¼‘å¾Œä¿ç•™é å‚™é‡‘è¨­å¾—å¤ é«˜(ä¾‹å¦‚20%~30%)ï¼Œä¸¦åœ¨å¸‚å ´å¤§è·Œæ™‚æš«ä¸æé ˜ï¼Œç”šè‡³å°åŠ ç¢¼ï¼Œå‰‡ä»å¯æ”¾å¿ƒäº«å—å¸‚å ´å ±é…¬ã€‚ã€Œä¸‹è·Œæ™‚æ²’æœ‰å°éº¥çš„äººï¼Œä¸Šæ¼²æ™‚ä¹Ÿä¸æœƒæœ‰å°éº¥ã€‚ã€
            </div>
        </div>

        <button class="btn-calc btn-young" onclick="calcYoung()">ğŸ”® é æ¸¬æœªä¾†è³‡ç”¢ & ç”Ÿæ´»å“è³ª</button>
        <div class="hint" style="text-align:center;">é»æ“Šå¾Œå°‡é¡¯ç¤ºè³‡ç”¢ç´¯ç©æ›²ç·šèˆ‡æœªä¾†æœˆè–ª</div>
    </div>

    <div id="result-area" class="result-box">
        <div class="result-header">
            <div class="purchasing-power-badge">âœ¨ é‡‘é¡çš†å·²æ›ç®—ç‚ºã€Œä»Šæ—¥è³¼è²·åŠ›ã€</div>
            <div id="result-summary"></div>
            <div id="house-impact-msg" style="margin-top:15px; padding:10px; background:#fce4ec; border-radius:8px; color:#c2185b; display:none; font-size:0.9em; line-height:1.5;"></div>
            <div class="hint" style="margin-top:10px;">(é€™ä»£è¡¨ï¼šé›–ç„¶å¸³é¢ä¸Šé‡‘é¡å¾ˆå¤§ï¼Œä½†å¯¦éš›èƒ½è²·åˆ°çš„æ±è¥¿ï¼Œç›¸ç•¶æ–¼ç¾åœ¨é€™å€‹é‡‘é¡çš„åƒ¹å€¼)</div>
        </div>
        
        <div id="comparison-block" class="comparison-box" style="display:none;">
            <div>
                <div class="comp-label">å‚³çµ±å¹³æ»‘æé ˜æ³• (å›ºå®šèŠ±è²»)</div>
                <div class="comp-note">è‹¥æ‚¨é¸æ“‡é€™ç­†éŒ¢å¹³å‡èŠ±åˆ°æ­»...</div>
            </div>
            <div class="vs-badge">VS</div>
            <div style="text-align:right;">
                <div class="comp-val" id="flat-val">$0</div>
                <div class="comp-note">æ¯æœˆå¯èŠ± (å¯¦è³ªè³¼è²·åŠ›)</div>
            </div>
        </div>

        <div id="dwz-section-title" class="dwz-section-title" style="display:none;">
            ğŸ‘‡ Die With Zero å»ºè­°æé ˜æ³• (3-2-1 éšæ¢¯å¼)
        </div>

        <div class="phase-container" id="phase-container">
            </div>

        <div id="acc-chart-container" style="display:none;">
            <div class="chart-header">ğŸ“ˆ ç¬¬ä¸€éšæ®µï¼šè³‡ç”¢ç´¯ç©é æ¸¬ (è‡³é€€ä¼‘)</div>
            <div class="chart-wrap">
                <canvas id="chartAcc"></canvas>
            </div>
        </div>

        <div class="chart-header">ğŸ“‰ ç¬¬äºŒéšæ®µï¼šé€€ä¼‘å¾Œæé ˜èˆ‡æ¶ˆè²» (Die With Zero vs å‚³çµ±)</div>
        <div class="chart-wrap">
            <canvas id="chartDec"></canvas>
        </div>

        <div class="hint" style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <strong>åœ–è¡¨èªªæ˜ï¼š</strong><br>
            <span style="color:#e67e22">â–  å½©è‰²æŸ±ç‹€åœ–</span>ï¼šDie With Zero å»ºè­°èŠ±è²» (å¹´è¼•å¤šèŠ±)ã€‚<br>
            <span style="color:#7f8c8d; text-decoration: underline dashed;">-- ç°è‰²è™›ç·š</span>ï¼šå‚³çµ±å¹³æ»‘åˆ†é… (æ¯å¹´èŠ±ä¸€æ¨£å¤š)ã€‚
        </div>
    </div>

    <div class="footer-note">
        <h4>æœ¬é æ¡æœ€ä¿å®ˆçš„å¹´è¤‡åˆ©ç®—æ³•ã€‚</h4>
        <p>èªªæ˜ï¼š<br>åœ¨è¨­å®šå¹´åŒ–å ±é…¬ç‡ï¼ˆä¾‹å¦‚ 15%ï¼‰é€²è¡Œå®šæœŸå®šé¡è©¦ç®—æ™‚ï¼Œã€Œæœˆåˆ©ç‡ã€æ˜¯å¦‚ä½•è¢«å®šç¾©çš„ï¼Œå°‡æ±ºå®šæœ€çµ‚è³‡ç”¢çš„å·¨å¤§å·®ç•°ã€‚ä»¥ä¸‹æ˜¯ä¸‰ç¨®æœ€å¸¸è¦‹çš„è¨ˆç®—é‚è¼¯ï¼š</p>
        <ol>
            <li>
                <strong>éŠ€è¡Œç®—æ³•ï¼šåç›®åˆ©ç‡</strong><br>
                å‡è¨­å¹´åˆ©ç‡ç›´æ¥é™¤ä»¥ 12 å°±æ˜¯æœˆåˆ©ç‡ã€‚<br>
                ç‰¹æ€§ï¼šé›–ç„¶åç¾©ä¸Šèªªæ˜¯ 15%ï¼Œä½†å› ç‚ºæ¯å€‹æœˆç”¢ç”Ÿçš„åˆ©æ¯åœ¨ä¸‹å€‹æœˆæœƒç¹¼çºŒæ»¾åˆ©ï¼Œå¯¦éš›ä¸€æ•´å¹´ä¸‹ä¾†çš„ã€Œæœ‰æ•ˆå¹´åˆ©ç‡ (EAR)ã€å…¶å¯¦é«˜é” 16.07%ã€‚<br>
                é©ç”¨æƒ…å¢ƒï¼šéŠ€è¡Œæˆ¿è²¸ã€è»Šè²¸æœˆä»˜æ¬¾è¨ˆç®—ã€‚
            </li>
            <li>
                <strong>æŠ•è³‡åš´è¬¹ç®—æ³•ï¼šæœ‰æ•ˆåˆ©ç‡</strong><br>
                é€™æ˜¯å°ˆæ¥­è²¡ç¶“ç¶²ç«™æˆ–åŸºé‡‘å…¬å¸å¸¸ç”¨çš„ç®—æ³•ã€‚å®ƒåš´æ ¼å®šç¾©ã€Œä¸€å¹´ä¸‹ä¾†å°±æ˜¯å‰›å¥½ 15%ã€ï¼Œå› æ­¤æœƒåæ¨å›è¼ƒä½çš„æœˆåˆ©ç‡ã€‚<br>
                ç‰¹æ€§ï¼šé€™æ˜¯æ•¸å­¸ä¸Šæœ€ç²¾ç¢ºçš„ã€Œå¹´åŒ–å ±é…¬ç‡ã€å®šç¾©ã€‚å› ç‚ºæœˆåˆ©ç‡åªæœ‰ 1.171%ï¼ˆä½æ–¼ä¸Šé¢çš„ 1.25%ï¼‰ï¼Œæ‰€ä»¥æœ€çµ‚ç´¯ç©é‡‘é¡æœƒé¡¯è‘—è¼ƒå°‘ã€‚<br>
                é©ç”¨æƒ…å¢ƒï¼šè‚¡ç¥¨ã€ETFã€åŸºé‡‘çš„é•·æœŸå›æ¸¬æ•¸æ“š (CAGR)ã€‚
            </li>
            <li>
                <strong>ç°¡æ˜“ä¼°ç®—ï¼šå¹´è¤‡åˆ© (æœ¬è¨ˆç®—æ©Ÿæ¡ç”¨)</strong><br>
                å®ƒä¸è¨ˆç®—æ¯å€‹æœˆçš„è¤‡åˆ©ï¼Œè€Œæ˜¯å‡è¨­éŒ¢æŠ•å…¥å¾Œï¼Œè¦ç­‰åˆ°å¹´åº•æ‰ä¸€æ¬¡æ€§çµç®—åˆ©æ¯ã€‚<br>
                é‚è¼¯ï¼šå¿½ç•¥æœˆè¤‡åˆ©ï¼Œæ¯å¹´åªæ»¾å‹•ä¸€æ¬¡ã€‚<br>
                è¨ˆç®—ï¼šæ¯æœˆå®šæœŸå®šé¡çš„éŒ¢ç°¡å–®åŠ ç¸½è¦–ç‚ºå¹´åº•æŠ•å…¥ï¼Œè‹¥é è¨­15%ï¼Œå‰‡ä»¥å¹´åˆæœ¬é‡‘ç›´æ¥ä¹˜ä»¥ 1.15ã€‚<br>
                ç‰¹æ€§ï¼šå› ç‚ºå®ƒå¿½ç•¥äº†ã€Œè³‡é‡‘åœ¨ä¸€å¹´ä¹‹ä¸­ç”¢ç”Ÿçš„æ™‚é–“åƒ¹å€¼ã€ï¼Œæ‰€ä»¥ç®—å‡ºä¾†çš„é‡‘é¡æœƒæ˜¯æœ€å°‘çš„(æœ€ä¿å®ˆ)ã€‚<br>
                é©ç”¨æƒ…å¢ƒï¼šåšé€€ä¼‘è¨ˆåŠƒæ™‚(ä¿å®ˆè¨ˆç®—ç•¶åšå®‰å…¨é‚Šéš›çš„ä¸€éƒ¨åˆ†)
            </li>
        </ol>
    </div>
</div>

<script>
    // --- Constants for Custom Portfolio ---
    // Conservative Annual Return Estimates
    const TICKER_DATA = {
        '0050': 8.0,
        '0056': 5.5,
        '00631L': 15.0,
        'VOO': 9.0,
        'QQQ': 11.0,
        'QLD': 14.0,   // ~2x QQQ (Conservative estimate)
        'TQQQ': 18.0   // ~3x QQQ (Conservative estimate)
    };
    
    // --- Init ---
    window.onload = function() {
        renderCustomPortfolioInputs('cp-box-young', 'young');
        renderCustomPortfolioInputs('cp-box-retire', 'retire');
    };

    function renderCustomPortfolioInputs(containerId, suffix) {
        const container = document.getElementById(containerId);
        let html = '';
        for (let i = 0; i < 5; i++) {
            html += `
                <div class="cp-row">
                    <select id="cp-tick-${suffix}-${i}" onchange="calcCustomRate('${suffix}')">
                        <option value="" disabled selected>é¸æ“‡æ¨™çš„</option>
                        <option value="0050">0050 (å…ƒå¤§å°ç£50)</option>
                        <option value="0056">0056 (å…ƒå¤§é«˜è‚¡æ¯)</option>
                        <option value="00631L">00631L (æ­£2)</option>
                        <option value="VOO">VOO (S&P 500)</option>
                        <option value="QQQ">QQQ (Nasdaq 100)</option>
                        <option value="QLD">QLD (Nasdaq 2x)</option>
                        <option value="TQQQ">TQQQ (Nasdaq 3x)</option>
                    </select>
                    <input type="number" id="cp-pct-${suffix}-${i}" placeholder="%" oninput="calcCustomRate('${suffix}')">
                </div>
            `;
        }
        html += `<div class="cp-footer">é æœŸå ±é…¬ç‡: <span id="cp-res-${suffix}" style="font-weight:bold; color:#e67e22">0.0</span>% (ç¸½ä½”æ¯”: <span id="cp-sum-${suffix}">0</span>%)</div>`;
        container.innerHTML += html;
    }

    function toggleCustom(mode, show) {
        const box = document.getElementById(mode === 'young' ? 'cp-box-young' : 'cp-box-retire');
        const inputId = mode === 'young' ? 'y-rate-acc' : 'r-rate';
        
        if (show) {
            box.style.display = 'block';
            calcCustomRate(mode); // Calc immediately
        } else {
            box.style.display = 'none';
        }

        // Handle visual selection class
        const presets = event.target.closest('.presets');
        if (presets) {
            presets.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
            event.target.classList.add('selected');
        }
    }

    function calcCustomRate(suffix) {
        let totalRate = 0;
        let totalPct = 0;

        for (let i = 0; i < 5; i++) {
            const ticker = document.getElementById(`cp-tick-${suffix}-${i}`).value;
            const pct = parseFloat(document.getElementById(`cp-pct-${suffix}-${i}`).value) || 0;
            
            if (ticker && TICKER_DATA[ticker]) {
                totalRate += TICKER_DATA[ticker] * (pct / 100);
            }
            totalPct += pct;
        }

        // Display results
        document.getElementById(`cp-sum-${suffix}`).innerText = totalPct;
        const finalRate = Math.round(totalRate * 10) / 10;
        document.getElementById(`cp-res-${suffix}`).innerText = finalRate;

        // Auto update main input if valid
        if (totalPct > 0) {
            const targetId = suffix === 'young' ? 'y-rate-acc' : 'r-rate';
            document.getElementById(targetId).value = finalRate;
        }
    }

    // --- UI Helpers ---
    function switchMode(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.mode-${mode}`).classList.add('active');
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('result-area').style.display = 'none';
        
        document.querySelectorAll('.presets .tag').forEach(t => t.classList.remove('selected'));
    }

    function setVal(id, val) {
        document.getElementById(id).value = val;
        const presets = event.target.closest('.presets');
        if (presets) {
            presets.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
            event.target.classList.add('selected');
        }
    }

    function toggleHouse() {
        const section = document.getElementById('house-section');
        const checkbox = document.getElementById('house-enabled');
        const text = document.getElementById('house-toggle-text');
        
        if (section.style.display === 'block') {
            section.style.display = 'none';
            section.classList.remove('show');
            checkbox.checked = false;
            text.innerText = "ğŸ  è²·æˆ¿è¨ˆç•« (é»æ“Šå±•é–‹è©¦ç®—)";
            text.style.color = "#8e44ad";
        } else {
            section.style.display = 'block';
            setTimeout(() => section.classList.add('show'), 10);
            checkbox.checked = true;
            text.innerText = "ğŸ  è²·æˆ¿è¨ˆç•« (å·²å•Ÿç”¨)";
            text.style.color = "#27ae60";
        }
    }

    function copyRateToDec() {
        const accRate = document.getElementById('y-rate-acc').value;
        document.getElementById('y-rate-dec').value = accRate;
        const presets = event.target.closest('.presets');
        if (presets) {
            presets.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
            event.target.classList.add('selected');
        }
    }

    function formatMoney(num) {
        if (isNaN(num)) return "0";
        return Math.round(num).toLocaleString('zh-TW');
    }

    function getNum(id) {
        const val = document.getElementById(id).value;
        return val === "" ? 0 : parseFloat(val);
    }

    // --- Math Helpers ---
    function PMT_Loan(rate, nper, pv) {
        if (rate === 0) return pv / (nper * 12);
        const r = rate / 100 / 12;
        const n = nper * 12;
        return (pv * r) / (1 - Math.pow(1 + r, -n));
    }

    function PMT_Annuity(principal, realRate, years) {
        const r = realRate / 100;
        if (r === 0) return principal / years;
        return (principal * r) / (1 - Math.pow(1 + r, -years));
    }

    function calculateBaseUnit(principal, realRate, totalYears) {
        const r = realRate / 100;
        const bucketSize = totalYears / 3; 
        let denominator = 0;

        for (let t = 1; t <= totalYears; t++) {
            let weight = 1;
            if (t <= bucketSize) weight = 3;
            else if (t <= bucketSize * 2) weight = 2;
            denominator += weight / Math.pow(1 + r, t);
        }
        return principal / denominator;
    }

    // --- é€€ä¼‘æ¨¡å¼é‚è¼¯ ---
    function calcRetire() {
        try {
            const assets = getNum('r-assets') * 10000;
            const buffer = getNum('r-buffer') * 10000;
            const ageNow = getNum('r-age-now');
            const ageEnd = getNum('r-age-end');
            const rateNominal = getNum('r-rate');
            const inflation = getNum('inflation');

            if (ageEnd <= ageNow) return alert("ç™»å‡ºå¹´é½¡éœ€å¤§æ–¼ç›®å‰å¹´é½¡");
            
            const principal = assets - buffer;
            if (principal <= 0) return alert("è³‡ç”¢ä¸è¶³ä»¥ä¿ç•™é å‚™é‡‘ï¼Œè«‹èª¿æ•´é‡‘é¡");

            const realRate = ((1 + rateNominal/100) / (1 + inflation/100) - 1) * 100;
            const years = ageEnd - ageNow;

            const baseUnit = calculateBaseUnit(principal, realRate, years);
            const flatAnnual = PMT_Annuity(principal, realRate, years);

            renderResults(ageNow, years/3, baseUnit, principal, "é€€ä¼‘æ¨¡å¼", 0, 0, "", [], [], flatAnnual);
        } catch (e) {
            alert("è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ•¸å€¼");
            console.error(e);
        }
    }

    // --- å¹´è¼•äººæ¨¡å¼é‚è¼¯ ---
    function calcYoung() {
        try {
            const ageNow = getNum('y-age-now');
            const ageRetire = getNum('y-age-retire');
            const ageEnd = getNum('y-age-end');
            const currentAsset = getNum('y-current') * 10000;
            let monthlyInv = getNum('y-monthly');
            const rateAcc = getNum('y-rate-acc') / 100;
            const inflation = getNum('inflation');
            
            if (ageRetire <= ageNow) return alert("é€€ä¼‘å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡");
            if (ageEnd <= ageRetire) return alert("ç™»å‡ºå¹´é½¡å¿…é ˆå¤§æ–¼é€€ä¼‘å¹´é½¡");

            const houseEnabled = document.getElementById('house-enabled').checked;
            const houseAge = getNum('h-age');
            const housePrice = getNum('h-price') * 10000;
            const downPct = getNum('h-down-pct');
            const mortgageRate = getNum('h-rate');
            const mortgageYears = getNum('h-years');
            const originalRent = getNum('h-rent');

            let currentMoney = currentAsset;
            let annualPool = 0; // ç´¯ç©é€™ä¸€å¹´å®šæœŸå®šé¡çš„éŒ¢ (å°šæœªæ»¾å…¥æœ¬é‡‘)

            let chartData = [];
            let chartLabels = [];
            let houseMsg = "";
            let isBankrupt = false;

            const totalMonths = (ageRetire - ageNow) * 12;
            
            for (let m = 0; m <= totalMonths; m++) {
                let currentAge = ageNow + Math.floor(m / 12);
                let currentMonthOfYear = m % 12;

                // --- House Logic ---
                let isHouseTrigger = (houseEnabled && currentAge === houseAge && currentMonthOfYear === 0);
                if (houseEnabled && houseAge === ageNow && m === 0) isHouseTrigger = true; 
                if (houseEnabled && houseMsg !== "" && isHouseTrigger) isHouseTrigger = false; 

                if (isHouseTrigger) {
                    const downPayment = housePrice * (downPct / 100);
                    
                    // æª¢æŸ¥æ˜¯å¦è¶³å¤ æ”¯ä»˜é ­æœŸæ¬¾ (æœ¬é‡‘ + å°šæœªçµç®—çš„å¹´åº¦è³‡é‡‘æ± )
                    if ((currentMoney + annualPool) < downPayment) {
                        alert(`è­¦å‘Šï¼šåœ¨ ${houseAge} æ­²æ™‚ï¼Œæ‚¨çš„è³‡ç”¢ç´¯ç©åƒ… ${formatMoney((currentMoney + annualPool)/10000)} è¬ï¼Œä¸è¶³ä»¥æ”¯ä»˜é ­æœŸæ¬¾ ${formatMoney(downPayment/10000)} è¬ã€‚\nè«‹å»¶å¾Œè²·æˆ¿ã€é™ä½æˆ¿åƒ¹æˆ–å¢åŠ åˆæœŸæŠ•å…¥ã€‚`);
                        return; 
                    }
                    
                    // æ‰£é™¤é ­æœŸæ¬¾ (å„ªå…ˆæ‰£é™¤æœ¬é‡‘ï¼Œä¸è¶³å†æ‰£è³‡é‡‘æ± ï¼Œé€™è£¡ç°¡åŒ–ç‚ºç¸½é¡æ‰£é™¤)
                    // é‡æ–°åˆ†é…ï¼š
                    let totalAvailable = currentMoney + annualPool - downPayment;
                    currentMoney = totalAvailable; 
                    annualPool = 0; // é‡ç½®è³‡é‡‘æ± ï¼Œè¦–ç‚ºå…¨éƒ¨æ•´ç†é
                    
                    const loanAmount = housePrice - downPayment;
                    const monthlyMortgage = PMT_Loan(mortgageRate, mortgageYears, loanAmount);
                    const extraCost = monthlyMortgage - originalRent; 
                    monthlyInv -= extraCost; 

                    houseMsg = `
                        <strong>ğŸ  è²·æˆ¿è¡æ“Šåˆ†æï¼š</strong><br>
                        æ‚¨åœ¨ ${houseAge} æ­²æ”¯ä»˜äº†é ­æœŸæ¬¾ <strong>$${formatMoney(downPayment/10000)}è¬</strong>ã€‚<br>
                        æ¯æœˆæˆ¿è²¸ç´„ <strong>$${formatMoney(monthlyMortgage)}</strong> (åŸæˆ¿ç§Ÿ $${formatMoney(originalRent)})ã€‚<br>
                        é€™å°è‡´æ‚¨æ¯æœˆçš„æŠ•è³‡é‡‘é¡å¾ <strong>$${formatMoney(getNum('y-monthly'))}</strong> 
                        ${extraCost > 0 ? `<span style='color:#c0392b'>æ¸›å°‘ç‚º</span>` : `<span style='color:#27ae60'>å¢åŠ ç‚º</span>`} 
                        <strong>$${formatMoney(monthlyInv)}</strong>ã€‚
                    `;
                }

                // --- Record Chart Data (Yearly) ---
                if (m % 12 === 0 || m === totalMonths) {
                    chartLabels.push(`${currentAge}æ­²`);
                    // åœ–è¡¨é¡¯ç¤ºçš„æ˜¯å·²çµç®—çš„æœ¬é‡‘ + ç•¶å¹´åº¦å°šæœªçµç®—çš„ç¾é‡‘
                    chartData.push(Math.round(currentMoney + annualPool));
                }

                // --- Accumulation Logic (Modified: Annual Rolling Only) ---
                if (m < totalMonths) { 
                    // 1. éŒ¢åªæ˜¯å…ˆæ”¾è‘— (Simple Sum)
                    annualPool += monthlyInv;

                    // 2. åªæœ‰åœ¨å¹´åº• (12æœˆçµæŸæ™‚)ï¼Œæ‰å°‡æœ¬é‡‘æ»¾å‹•ï¼Œä¸¦å°‡é€™ä¸€å¹´çš„éŒ¢ä½µå…¥
                    // m=0(Jan)..m=11(Dec) -> (m+1)%12 == 0
                    if ((m + 1) % 12 === 0) {
                        // æœ¬é‡‘æ»¾åˆ© (Yearly Compounding)
                        currentMoney = currentMoney * (1 + rateAcc);
                        // å°‡é€™ä¸€å¹´å­˜çš„éŒ¢ä½µå…¥æœ¬é‡‘ (è¦–ç‚ºå¹´åº•ä¸€æ¬¡æŠ•å…¥)
                        currentMoney += annualPool;
                        // æ¸…ç©ºè³‡é‡‘æ± 
                        annualPool = 0;
                    }
                }

                if (currentMoney < 0) {
                    isBankrupt = true;
                    currentMoney = 0; 
                }
            }

            if (isBankrupt) {
                alert("è­¦å‘Šï¼šè²·æˆ¿å¾Œçš„æˆ¿è²¸è² æ“”éé‡ï¼Œå°è‡´æ‚¨çš„æŠ•è³‡è³‡ç”¢åœ¨é€€ä¼‘å‰å·²è€—ç›¡ï¼è«‹é™ä½æˆ¿åƒ¹æˆ–å¢åŠ æ”¶å…¥ã€‚");
                return;
            }

            // é€€ä¼‘é‡‘å¤–åŠ 
            const pension = getNum('y-pension') * 10000;
            // ç¸½é¡ = æ»¾å‹•å¾Œçš„æœ¬é‡‘ + (å¦‚æœé€€ä¼‘ä¸æ˜¯åœ¨å¹´åº•ï¼Œå¯èƒ½é‚„æœ‰æ®˜å­˜çš„ annualPool) + é€€ä¼‘é‡‘
            let totalNominal = currentMoney + annualPool + pension;
            
            const yearsAcc = ageRetire - ageNow;
            let totalReal = totalNominal / Math.pow(1 + inflation/100, yearsAcc);

            const bufferPct = getNum('y-buffer-pct');
            let playMoneyReal = totalReal * (1 - bufferPct/100);
            
            const rateDecNominal = getNum('y-rate-dec');
            const realRateDec = ((1 + rateDecNominal/100) / (1 + inflation/100) - 1) * 100;
            const yearsDec = ageEnd - ageRetire;
            
            const baseUnit = calculateBaseUnit(playMoneyReal, realRateDec, yearsDec);
            const flatAnnual = PMT_Annuity(playMoneyReal, realRateDec, yearsDec);

            renderResults(ageRetire, yearsDec/3, baseUnit, playMoneyReal, "å¹´è¼•äººæ¨¡å¼", totalNominal, totalReal, houseMsg, chartLabels, chartData, flatAnnual);

        } catch (e) {
            alert("è¨ˆç®—éç¨‹ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰æ¬„ä½è¼¸å…¥äº†éæ•¸å­—çš„ç¬¦è™Ÿã€‚");
            console.error(e);
        }
    }

    // --- Rendering ---
    let chartInstanceAcc = null;
    let chartInstanceDec = null;

    function renderResults(startAge, bucketSize, baseUnit, totalRealMoney, mode, nominalFV=0, realFV=0, houseMsg="", chartLabels=[], chartData=[], flatAnnual=0) {
        const area = document.getElementById('result-area');
        area.style.display = 'block';
        area.scrollIntoView({ behavior: 'smooth' });

        // Summary
        let html = '';
        if (mode === "é€€ä¼‘æ¨¡å¼") {
            html = `<h2 style="margin:0; color:#2c3e50">æ‚¨çš„äº«æ¨‚æœ¬é‡‘ (ç¾å€¼)ï¼š${formatMoney(totalRealMoney/10000)} è¬</h2>`;
        } else {
            html = `
                <h3 style="margin:5px 0; color:#7f8c8d">${startAge} æ­²ç´¯ç©è³‡ç”¢ï¼š${formatMoney(nominalFV/10000)} è¬</h3>
                <h2 style="margin:0; color:#27ae60">ä»Šæ—¥è³¼è²·åŠ›ï¼š${formatMoney(realFV/10000)} è¬</h2>
            `;
        }
        document.getElementById('result-summary').innerHTML = html;

        // House Message
        const msgDiv = document.getElementById('house-impact-msg');
        if (houseMsg) {
            msgDiv.style.display = 'block';
            msgDiv.innerHTML = houseMsg;
        } else {
            msgDiv.style.display = 'none';
        }

        // Comparison Box
        const compBox = document.getElementById('comparison-block');
        compBox.style.display = 'flex';
        document.getElementById('flat-val').innerText = `$${formatMoney(flatAnnual/12)}`;

        // Header Visibility
        document.getElementById('dwz-section-title').style.display = 'flex';

        // Phase Cards
        const m1 = (baseUnit * 3) / 12;
        const m2 = (baseUnit * 2) / 12;
        const m3 = (baseUnit * 1) / 12;
        const p1End = Math.floor(startAge + bucketSize);
        const p2End = Math.floor(startAge + bucketSize * 2);
        const p3End = Math.floor(startAge + bucketSize * 3);

        document.getElementById('phase-container').innerHTML = `
            <div class="phase-card p-gold">
                <div class="p-title">ğŸš€ é»ƒé‡‘æœŸ (${startAge} - ${p1End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m1)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ± (å¯¦è³ªè³¼è²·åŠ›)</div>
            </div>
            <div class="phase-card p-silver">
                <div class="p-title">ğŸš¢ ç™½éŠ€æœŸ (${p1End} - ${p2End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m2)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ±</div>
            </div>
            <div class="phase-card p-bronze">
                <div class="p-title">ğŸ¡ æ…¢æ´»æœŸ (${p2End} - ${p3End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m3)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ±</div>
            </div>
        `;

        // Chart Rendering Logic
        const accContainer = document.getElementById('acc-chart-container');
        
        // Always draw Decumulation Chart (Bottom)
        drawDecChart(startAge, bucketSize * 3, bucketSize, baseUnit, flatAnnual);

        // If Young Mode, also draw Accumulation Chart (Top)
        if (mode === "å¹´è¼•äººæ¨¡å¼" && chartData.length > 0) {
            accContainer.style.display = 'block';
            drawAccChart(chartLabels, chartData);
        } else {
            accContainer.style.display = 'none';
        }
    }

    function drawAccChart(labels, data) {
        const ctx = document.getElementById('chartAcc').getContext('2d');
        if (chartInstanceAcc) chartInstanceAcc.destroy();
        
        chartInstanceAcc = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'è³‡ç”¢ç´¯ç© (åç›®é‡‘é¡)',
                    data: data,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'ç¸½è³‡ç”¢ (å…ƒ)' } }
                }
            }
        });
    }

    function drawDecChart(startAge, totalYears, bucketSize, baseUnit, flatAnnual) {
        const ctx = document.getElementById('chartDec').getContext('2d');
        if (chartInstanceDec) chartInstanceDec.destroy();

        let labels = [];
        let data = [];
        let dataFlat = [];
        let backgroundColors = [];

        for (let i = 0; i < totalYears; i++) {
            labels.push(`${startAge + i}æ­²`);
            
            let val = 0;
            let color = '';
            if (i < bucketSize) {
                val = baseUnit * 3;
                color = 'rgba(241, 196, 15, 0.7)'; 
            } else if (i < bucketSize * 2) {
                val = baseUnit * 2;
                color = 'rgba(189, 195, 199, 0.7)'; 
            } else {
                val = baseUnit * 1;
                color = 'rgba(144, 224, 239, 0.7)'; 
            }
            data.push(val);
            dataFlat.push(flatAnnual);
            backgroundColors.push(color);
        }

        chartInstanceDec = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'å‚³çµ±å¹³æ»‘æé ˜ (å›ºå®š)',
                        data: dataFlat,
                        borderColor: '#95a5a6',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        order: 0
                    },
                    {
                        type: 'bar',
                        label: 'Die With Zero å»ºè­° (éšæ¢¯)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        borderRadius: 4,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'å¹´åº¦é ç®— (å¯¦è³ªè³¼è²·åŠ›)' } }
                }
            }
        });
    }
</script>

</body>
</html>
